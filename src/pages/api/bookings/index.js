import { connect } from '@/lib/mongoose'; import BookingModel from '@/models/Booking'; import User from '@/models/User'; import Mentor from '@/models/Mentor'; import cookie from 'cookie'; export default async function handler(req,res){ await connect(); const cookies = cookie.parse(req.headers.cookie || ''); const id = cookies.almukai_uid; if(!id) return res.status(400).json({ error:'Login required' }); if(req.method==='POST'){ const { mentorId, when } = req.body; const user = await User.findById(id); const mentor = await Mentor.findById(mentorId); if(!mentor) return res.status(400).json({ error:'Mentor not found' }); if(user.role!=='premium'){ if((user.credits||0)<10) return res.status(400).json({ error:'Not enough credits (10 required)' }); user.credits -= 10; await user.save(); } const booking = await BookingModel.create({ userId:user._id, mentorId, when, status:'confirmed' }); return res.json({ booking }); } if(req.method==='GET'){ const bookings = await BookingModel.find().lean(); return res.json({ bookings }); } res.status(405).end(); }
